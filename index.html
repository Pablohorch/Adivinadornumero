<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Adivina el número</title>
<style>
  /* Diseño responsive y atractivo */
  body {
    font-family: system-ui, sans-serif;
    margin: 0;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
    color: #333;
  }

  main {
    width: 100%;
    max-width: 480px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  h1 {
    text-align: center;
    margin: 0;
  }

  form {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
  }

  .button-row {
    display: flex;
    gap: 0.5rem;
  }

  button,
  input,
  textarea {
    font-size: 1rem;
    padding: 0.75rem;
    min-height: 44px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  button {
    background-color: #4e54c8;
    color: #fff;
    border: none;
    cursor: pointer;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  button:focus,
  input:focus {
    outline: 2px solid #005fcc;
    outline-offset: 2px;
  }

  #guessInput {
    width: 100%;
    box-sizing: border-box;
  }

  .feedback {
    min-height: 1.5em;
  }

  .overlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
  }

  .overlay-content {
    background: rgba(0, 0, 0, 0.6);
    padding: 2rem;
    border-radius: 12px;
    text-align: center;
  }

  .hidden {
    display: none;
  }
</style>
</head>
<body>
<main>
  <h1>Adivina el número</h1>
  <label for="digitsInput">Dígitos del número secreto</label>
  <input id="digitsInput" type="number" min="1" max="9" value="9">
  <button id="generateBtn" type="button">Generar número</button>
  <form id="guessForm" autocomplete="off">
    <label for="guessInput">Introduce tu número…</label>
    <input id="guessInput" type="text" inputmode="numeric" pattern="[0-9.]*" placeholder="Introduce tu número…">
      <div class="button-row">
        <button id="preFillBtn" type="button" disabled aria-disabled="true">PreEscribir</button>
        <button id="sendBtn" type="submit" disabled aria-disabled="true">Enviar</button>
      </div>
      </form>
      <output id="feedback" aria-live="polite" class="feedback"></output>
      <p id="attempts">Intentos: 0</p>
  <p id="range">Menor: 1 | Mayor: 3.000.000.000</p>
  <h2>Historial de intentos</h2>
  <ul id="history"></ul>
  <button id="resetBtn" type="button">Reiniciar</button>
  <h2>Ranking de intentos</h2>
  <ol id="rankingList"></ol>
  <h2>Multijugador</h2>
  <div class="button-row">
    <button id="hostBtn" type="button">Activar servidor</button>
    <button id="connectBtn" type="button">Conectar a servidor</button>
  </div>
  <p id="signalHint"></p>
  <textarea id="signalBox" class="hidden" placeholder="Código de conexión"></textarea>
  <button id="signalBtn" type="button" class="hidden">Procesar</button>
</main>
<div id="successScreen" class="overlay hidden">
  <div class="overlay-content">
    <p id="successMessage"></p>
    <button id="playAgainBtn" type="button">Jugar de nuevo</button>
  </div>
</div>
<script>
// Lógica del juego de adivinar el número
(function() {
  let max = 3000000000;
  let secret = null;
  let attempts = 0;
  const generateBtn = document.getElementById('generateBtn');
  const guessInput = document.getElementById('guessInput');
  const sendBtn = document.getElementById('sendBtn');
  const preFillBtn = document.getElementById('preFillBtn');
  const resetBtn = document.getElementById('resetBtn');
  const feedback = document.getElementById('feedback');
  const attemptsText = document.getElementById('attempts');
  const rangeText = document.getElementById('range');
  const historyList = document.getElementById('history');
  const form = document.getElementById('guessForm');
  const successScreen = document.getElementById('successScreen');
  const successMessage = document.getElementById('successMessage');
  const playAgainBtn = document.getElementById('playAgainBtn');
  const rankingList = document.getElementById('rankingList');
  const digitsInput = document.getElementById('digitsInput');
  const hostBtn = document.getElementById('hostBtn');
  const connectBtn = document.getElementById('connectBtn');
  const signalBox = document.getElementById('signalBox');
  const signalBtn = document.getElementById('signalBtn');
  const signalHint = document.getElementById('signalHint');
  const ranking = [];
  let lowerBound = 1;
  let upperBound = max;
  let commonPrefix = '';
  let pc = null;
  let dc = null;

  function formatNumber(n) {
    return n.toLocaleString('es-ES');
  }

  function boldCommonDigits(text, prefixLen) {
    let result = '';
    let count = 0;
    let opened = false;
    for (const ch of text) {
      if (ch === '.') {
        result += ch;
      } else {
        if (count === 0 && prefixLen > 0) {
          result += '<b>';
          opened = true;
        }
        result += ch;
        count++;
        if (count === prefixLen && opened) {
          result += '</b>';
          opened = false;
        }
      }
    }
    if (opened) result += '</b>';
    return result;
  }

  function updateRangeText() {
    const minText = formatNumber(lowerBound);
    const maxText = formatNumber(upperBound);
    const minRaw = String(lowerBound);
    const maxRaw = String(upperBound);
    let prefixLen = 0;
    while (minRaw[prefixLen] && minRaw[prefixLen] === maxRaw[prefixLen]) prefixLen++;
    commonPrefix = minRaw.slice(0, prefixLen);
    const minHTML = boldCommonDigits(minText, prefixLen);
    const maxHTML = boldCommonDigits(maxText, prefixLen);
    rangeText.innerHTML = 'Menor: ' + minHTML + ' | Mayor: ' + maxHTML;
    const enablePre = prefixLen > 0;
    preFillBtn.disabled = !enablePre;
    preFillBtn.setAttribute('aria-disabled', String(!enablePre));
  }

  function updateRanking() {
    rankingList.innerHTML = '';
    ranking.forEach((score, index) => {
      const li = document.createElement('li');
      li.textContent = `${index + 1}. ${score} intento${score !== 1 ? 's' : ''}`;
      rankingList.appendChild(li);
    });
  }

  function updateMaxFromDigits() {
    const digits = parseInt(digitsInput.value, 10) || 1;
    max = Math.pow(10, digits) - 1;
    upperBound = max;
    updateRangeText();
  }

  digitsInput.addEventListener('input', updateMaxFromDigits);

  function waitIceGathering(pc) {
    return new Promise(resolve => {
      if (pc.iceGatheringState === 'complete') {
        resolve();
      } else {
        pc.addEventListener('icegatheringstatechange', () => {
          if (pc.iceGatheringState === 'complete') resolve();
        });
      }
    });
  }

  async function startHosting() {
    generateSecret();
    pc = new RTCPeerConnection();
    dc = pc.createDataChannel('secret');
    dc.onopen = () => {
      dc.send(JSON.stringify({ secret, max }));
    };
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await waitIceGathering(pc);
    signalHint.textContent = 'Comparte este código con tu amigo y pega su respuesta.';
    signalBox.classList.remove('hidden');
    signalBtn.classList.remove('hidden');
    signalBox.value = btoa(JSON.stringify(pc.localDescription));
    signalBtn.textContent = 'Aceptar respuesta';
    signalBtn.onclick = async () => {
      const answer = JSON.parse(atob(signalBox.value.trim()));
      await pc.setRemoteDescription(answer);
      signalBtn.classList.add('hidden');
      signalBox.classList.add('hidden');
      signalHint.textContent = 'Conexión establecida.';
    };
  }

  async function connectToHost() {
    pc = new RTCPeerConnection();
    pc.ondatachannel = ev => {
      dc = ev.channel;
      dc.onmessage = e => {
        const msg = JSON.parse(e.data);
        secret = msg.secret;
        max = msg.max;
        digitsInput.value = String(String(max).length);
        lowerBound = 1;
        upperBound = max;
        attempts = 0;
        attemptsText.textContent = 'Intentos: 0';
        feedback.textContent = '';
        generateBtn.disabled = true;
        generateBtn.setAttribute('aria-disabled', 'true');
        updateRangeText();
        updateSendState();
      };
    };
    signalHint.textContent = 'Pega el código del servidor y pulsa conectar. Luego comparte tu respuesta.';
    signalBox.classList.remove('hidden');
    signalBtn.classList.remove('hidden');
    signalBox.value = '';
    signalBtn.textContent = 'Conectar';
    signalBtn.onclick = async () => {
      const offer = JSON.parse(atob(signalBox.value.trim()));
      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await waitIceGathering(pc);
      signalBox.value = btoa(JSON.stringify(pc.localDescription));
      signalBtn.textContent = 'Copia y envía este código al servidor';
    };
  }

  updateMaxFromDigits();
  updateRanking();

  // Habilita o deshabilita el botón Enviar según la entrada y si existe número secreto
    function updateSendState() {
    const raw = guessInput.value.trim().replace(/\./g, '');
    const isValid = secret !== null && raw !== '' &&
                    /^\d+$/.test(raw) && (n => n >= 1 && n <= max)(Number(raw));
    sendBtn.disabled = !isValid;
    sendBtn.setAttribute('aria-disabled', String(sendBtn.disabled));
    return isValid;
  }

  // Genera el número secreto
  function generateSecret() {
    if (window.crypto && crypto.getRandomValues) {
      const arr = new Uint32Array(1);
      crypto.getRandomValues(arr);
      secret = arr[0] % max + 1;
    } else {
      secret = Math.floor(Math.random() * max) + 1;
    }
    generateBtn.disabled = true;
    generateBtn.setAttribute('aria-disabled', 'true');
    attempts = 0;
    attemptsText.textContent = 'Intentos: 0';
    feedback.textContent = '';
    guessInput.value = '';
    sendBtn.disabled = true;
    sendBtn.setAttribute('aria-disabled', 'true');
    lowerBound = 1;
    upperBound = max;
    historyList.innerHTML = '';
    updateRangeText();
    guessInput.focus();
  }

  // Comprueba el intento del usuario
  function handleGuess() {
    if (!updateSendState()) return;
    const guess = Number(guessInput.value.replace(/\./g, ''));
    attempts++;
    attemptsText.textContent = 'Intentos: ' + attempts;
    let hint = '';
    if (guess === secret) {
      hint = 'Correcto';
      feedback.textContent = hint;
      ranking.push(attempts);
      ranking.sort((a, b) => a - b);
      updateRanking();
      successMessage.textContent = `¡Correcto! El número era ${formatNumber(secret)}. Lo adivinaste en ${attempts} intento${attempts !== 1 ? 's' : ''}.`;
      successScreen.classList.remove('hidden');
    } else if (guess < secret) {
      lowerBound = Math.max(lowerBound, guess);
      hint = 'Mayor';
      feedback.textContent = hint;
    } else {
      upperBound = Math.min(upperBound, guess);
      hint = 'Menor';
      feedback.textContent = hint;
    }
    updateRangeText();
    const li = document.createElement('li');
    li.textContent = formatNumber(guess) + ' → ' + hint;
    historyList.appendChild(li);
    applyPreFill();
  }

  // Reinicia el juego
  function resetGame() {
    secret = null;
    attempts = 0;
    attemptsText.textContent = 'Intentos: 0';
    feedback.textContent = '';
    guessInput.value = '';
    generateBtn.disabled = false;
    generateBtn.setAttribute('aria-disabled', 'false');
    sendBtn.disabled = true;
    sendBtn.setAttribute('aria-disabled', 'true');
    lowerBound = 1;
    upperBound = max;
    historyList.innerHTML = '';
    updateRangeText();
    successScreen.classList.add('hidden');
  }

  // Valida la entrada en cada cambio
  guessInput.addEventListener('input', () => {
    const digits = guessInput.value.replace(/\D/g, '');
    if (digits === '') {
      guessInput.value = '';
      feedback.textContent = '';
    } else {
      guessInput.value = formatNumber(Number(digits));
      const number = Number(digits);
      if (number < 1 || number > max) {
        feedback.textContent = 'Fuera de rango';
      } else {
        feedback.textContent = '';
      }
    }
    updateSendState();
  });

  function applyPreFill() {
    if (commonPrefix !== '') {
      guessInput.value = formatNumber(Number(commonPrefix));
      feedback.textContent = '';
    } else {
      guessInput.value = '';
    }
    updateSendState();
    guessInput.focus();
  }

  preFillBtn.addEventListener('click', applyPreFill);
  generateBtn.addEventListener('click', generateSecret);
  resetBtn.addEventListener('click', resetGame);
  playAgainBtn.addEventListener('click', () => {
    generateSecret();
    successScreen.classList.add('hidden');
  });
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    if (!sendBtn.disabled) handleGuess();
  });
  hostBtn.addEventListener('click', startHosting);
  connectBtn.addEventListener('click', connectToHost);
})();
</script>
</body>
</html>
